# 工作内容介绍
last update 2017/5/12

本文介绍到目前为止服务器方面的代码的主要工作，分4个小节，依次为进展、服务器概述与服务器-客户端报文格式与serlvet。

5/14 new

在服务器概述中新增了服务器对于文件请求的处理过程.

## 一、进展

数据库访问,控制连接与数据连接均已基本完成.

## 二、服务器概述

### 代码结构

DFS_Server类为服务器的主类，生成控制链接监听线程与数据链接监听进程；

目前的服务器除DFS_Server类外主要分3个包:

controlConnect包负责控制连接,其是在滕思洁设计的框架下经过了大量的修改后形成的，分为2个类实现:

ServerThread类为控制链接监听线程，为每个连接创建一个链接处理线程；

ClientThread类为控制链接处理线程，对于心跳链接、请求处理报文，其将一直运行并依照下一节描述的报文与客户端保持联系；

在ClientThread类中，主函数将不断接收报文直至收到出错报文或exit为止；对报文的理解与处理由readscentence函数进行。

dataConnect包负责数据连接，其也分为2个类实现:

ServerThread类为数据链接监听线程，为每个连接创建一个链接处理线程；

ClientThread类为数据链接处理线程，与控制连接不同,其不是常开的；

database包负责数据库访问,详见第一节.

### 文件处理过程

#### 请求文件碎片:

1.在数据库REQUEST中写入请求

2.客户端在下次心跳连接时将收到请求

3.客户端将新建一条与服务器的数据连接并将碎片发往服务器,发送后客户端上的碎片将不会被删除.

4.服务器收到碎片后将会把碎片保存到下载文件夹并删除数据库中的请求

#### 文件上传:

1.客户端需要向服务器发送上传文件报文

2.服务器收到报文后将会在数据库FILE中插入文件项并返回文件的ID.为了表示文件仍不可用,文件项的NOA字段将被设置为实际NOA的相反数

3.客户端接下来向服务器发送文件的各个碎片,其中最后一个碎片一定要最后一个发送,之前的碎片可以乱序发送.

4.服务器收到碎片后将会把碎片保存在本地临时文件夹并数据库FRAGMENT中插入碎片项.由于碎片未被分配到文件夹,此时PATH均为'-1'

5.服务器收到最后一个碎片后检测是否碎片已被全部上传,如是,将碎片分配到各个客户端并将数据库中文件项的NOA字段改为实际的碎片数量.分配的方法是在数据库REQUEST中写入请求等待客户端取走碎片

6.被分配到的客户端在下次心跳连接时将收到请求

7.客户端将新建一条与服务器的数据连接并接收碎片,发送完碎片后服务器将暂存的碎片删除,同时将数据库中碎片项的PATH改为设备的ID 

8.客户端收到碎片后将会把碎片保存到碎片文件夹,服务器完成传输后删除数据库中的请求

#### 碎片删除:

1.在数据库REQUEST中写入请求

2.客户端在下次心跳连接时将收到请求

3.客户端将删除这一碎片并新建一条与服务器的数据连接以通知服务器请求完成.

4.服务器通知后删除数据库中的请求

## 三、服务器-客户端报文格式

### 控制链接报文

#### 客户端状态报文

客户端发送：

1 {设备ID} {客户端剩余空间}

服务器回复:

received with {等待客户端处理的请求数量} unread request!

#### 处理请求报文：

客户端发送：

3 {设备ID}

服务器回复:

{请求ID} {碎片ID} {请求类型}

接下来进入相应的处理函数

#### 中断连接报文

客户端发送：

exit

----链接中断----

### 数据链接报文

#### 上传服务器请求的碎片到服务器

客户端发送:

1 {请求ID} {碎片ID}

服务器回复:

received!

客户端回复：

{碎片内容}

服务器回复:

received!

----链接中断----

#### 根据服务器请求下载碎片

客户端发送:

2 {请求ID} {碎片ID}

服务器回复:

{碎片内容}

客户端回复:

received!

----链接中断----

#### 客户端删除碎片

客户端发送:

3 {请求ID} {碎片ID}

服务器回复:

received!

----链接中断----

#### 上传文件报文

客户端发送：

4 {设备ID} {文件名} {路径} {属性} {碎片数量} {是不是文件夹}

服务器回复：

FileId: {文件ID}

----链接中断----

#### 上传文件碎片到服务器

(在上传文件碎片前，必须先通过上传文件报文从服务器获取文件的id)
(最后一个碎片一定要最后上传,这时服务器有可能回复UPLOADFAIL表示整个文件上传失败)

客户端发送:

5 {文件ID} {碎片序号} {碎片总数}

服务器回复:

received!

客户端回复:

{碎片内容}

服务器回复:

received!

----链接中断----

## 四、servlet（已过时）
servlet文件夹下利用网页访问数据库并查询目录列表的servlet，使用方法为:

将dfstest.html放到<Tomcat-installation-directory>/webapps/ROOT/

将File_Search.class和database整个目录放到<Tomcat-installation-directory>/webapps/ROOT/WEB-INF/classes/

将mysql-connector-java-5.1.39-bin.jar放到<Tomcat-installation-directory>/webapps/ROOT/WEB-INF/lib/

重启服务器,浏览器打开localhost:8080/dfstest.html,在文件目录访问测试中输入路径名,如数据库访问正常,将显示该路径下的文件列表.

（sourse目录下为源代码）
